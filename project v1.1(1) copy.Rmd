---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
#process dataset
library("tidyverse") 
library("car") 
library("rpart") 
library("rpart.plot") 
library("nnet") 
library("randomForest") 
library("effects")

setwd("~/Desktop/stat 350")
#read files
data1 = read.csv(file = "fundamentals.csv",header=TRUE, sep = ",")
#data2 = read.csv(file = "prices-split-adjusted.csv",header=TRUE, sep = ",")
#data3 = read.csv(file = "prices.csv",header=TRUE, sep = ",")
#data4 = read.csv(file = "securities.csv",header=TRUE, sep = ",")

data1$Ticker.Symbol = as.factor(data1$Ticker.Symbol)

#distinct data
new_data = distinct(data1)
#filter data
new_data <- filter(new_data,!is.na(For.Year))
new_data <- filter(new_data,!is.na(Earnings.Per.Share))
new_data <- filter(new_data,!is.na(Estimated.Shares.Outstanding))
new_data <- filter(new_data,Accounts.Receivable!=0)
new_data <- filter(new_data,!is.na(Accounts.Receivable))
```

```{r}
new_data = na.omit(new_data)
new_data
```

```{r}
#create a new dataset
new_var = cbind(new_data$Ticker.Symbol,new_data$Accounts.Receivable,new_data$Accounts.Payable,new_data$Cash.Ratio,new_data$Current.Ratio,new_data$Net.Borrowings,
                new_data$Add.l.income.expense.items,new_data$Net.Cash.Flow.Operating,new_data$Net.Cash.Flows.Financing,new_data$Cost.of.Revenue,
                new_data$Net.Income,new_data$Net.Income.Adjustments,new_data$Operating.Income,new_data$Net.Income.Cont..Operations,
                new_data$Net.Receivables,new_data$Operating.Margin, new_data$Profit.Margin,new_data$Quick.Ratio,new_data$Gross.Margin,new_data$Effect.of.Exchange.Rate)
new_names=c( "Ticker.Symbol", "Accounts.Receivable","Accounts.Payable" , "Cash.Ratio" , "Current.Ratio" 
           , "Net.Borrowings" , "Add.l.income.expense.items" , "Net.Cash.Flow.Operating" , 
           "Net.Cash.Flows.Financing" , "Cost.of.Revenue" , "Net.Income" ,
              "Net.Income.Adjustments", "Operating.Income" ,
           "Net.Income.Cont..Operations" , "Net.Receivables" ,
           "Operating.Margin", "Profit.Margin" , 
             "Quick.Ratio" , "Gross.Margin" , "Effect.of.Exchange.Rate")
colnames(new_var) = new_names
new_var = as.data.frame((new_var))
new_var = na.omit(new_var)
new_var

```

```{r}
str(new_var)
```



```{r}
#mod1 linear
#Ticker.Symbol + Operating.Margin
model1.linear = lm( Accounts.Receivable ~ ., data = new_var)
summary(model1.linear)
#plot(model1.linear)
```

```{r}
add = cbind("ALK", -7452000000, 7757085000, 66, 45, -11111111, -2823000000, 1030000000, -325000000, 11120000000, 508000000, 6090077000, 848000000, 605000000, 632705000, 10, 10, 300,  50,-1000)

add = matrix(add, nrow = 1)
#add = as.data.frame(add)
#add$Ticker.Symbol = as.numeric(add$Ticker.Symbol)
colnames(add) = colnames(new_var)
#add$Accounts.Receivable = as.numeric(add$Accounts.Recievable)
#add$Accounts.Receivable[1,] = as.numeric(add$Accounts.Recievable[1,])
#add[,2:20] = as.numeric(add[2:20])
add = as.data.frame(add)
add[,2:20] = sapply(add[,2:20], as.numeric)

#add = cbind(add[,1], as.numeric(add[,2:20]))

rbind(new_var, add)
new_var = rbind(new_var, add)
str(add)

```


```{r}
#add additional point
add = cbind("ALK", -7452000000, 7757085000, 66, 45, -11111111, -2823000000, 1030000000, -325000000, 11120000000, 508000000, 6090077000, 848000000, 605000000, 632705000, 10, 10, 300,  50,-1000)
add = matrix(add, nrow = 1)
add
colnames(add) = colnames(new_var)
#new_var = rbind(new_var, add)
#new_var$Ticker.Symbol = as.factor(new_var$Ticker.Symbol)
#new_var

```

```{r}
class(new_data)
class(new_var)
str(new_data)

```

```{r}
#new_var = as.data.frame(new_var)
#new_var = new_var[,2:20] = sapply(new_var[,2:20], as.numeric)
#Ticker.Symbol = as.character(Ticker.Symbol)
new_var = transform(new_var, Ticker.Symbol = as.numeric(Ticker.Symbol), Accounts.Receivable = as.numeric(Accounts.Receivable), Accounts.Payable = as.numeric(Accounts.Payable), Cash.Ratio = as.numeric(Cash.Ratio), Current.Ratio = as.numeric(Current.Ratio), Net.Borrowings = as.numeric(Net.Borrowings), Add.l.income.expense.items = as.numeric(Add.l.income.expense.items), Net.Cash.Flow.Operating = as.numeric(Net.Cash.Flow.Operating), Net.Cash.Flows.Financing = as.numeric(Net.Cash.Flows.Financing), Cost.of.Revenue = as.numeric(Cost.of.Revenue), Net.Income = as.numeric(Net.Income), Net.Income.Adjustments = as.numeric(Net.Income.Adjustments), Operating.Income = as.numeric(Operating.Income), Net.Income.Cont..Operations = as.numeric(Net.Income.Cont..Operations), Net.Receivables = as.numeric(Net.Receivables), Operating.Margin = as.numeric(Operating.Margin), Profit.Margin = as.numeric(Profit.Margin), Quick.Ratio = as.numeric(Quick.Ratio), Gross.Margin = as.numeric(Gross.Margin), Effect.of.Exchange.Rate = as.numeric(Effect.of.Exchange.Rate))
str(new_var)
```


```{r}
#mod1 linear
#Ticker.Symbol + Operating.Margin
model1.linear = lm( Accounts.Receivable ~ ., data = new_var)
summary(model1.linear)
plot(model1.linear)
```


```{r}
#mod2 step
model2.step = step(model1.linear)
summary(model2.step)
plot(model2.step)
```

```{r}
#mod3 decision tree
model3.rpart <- rpart(Accounts.Receivable ~ ., data = new_var, cp = 0.01, model = TRUE)
plotcp(model3.rpart)
printcp(model3.rpart) 
rpart.plot(model3.rpart, type = 0, fallen.leaves = TRUE, uniform = TRUE, yes.text = "TRUE", no.text = "FALSE", cex = .8)
```


```{r}
#mod4 random forest
model4.RF<-randomForest(Accounts.Receivable ~ ., data = new_var, mtry=sqrt(19), importance = TRUE)
model4.RF
importance(model4.RF,type = 2) 
varImpPlot(model4.RF,type = 2, main = "Importance Plot")
```


```{r}
#Partial Dependency Plot for Random Forest 
partialPlot(model4.RF, pred.data = new_data, x.var = Net.Receivables, sub = "Validation Set", which.class = "1")
partialPlot(model4.RF, pred.data = new_data, x.var = Net.Income.Adjustments, sub = "Validation Set", which.class = "1")
partialPlot(model4.RF, pred.data = new_data, x.var = Net.Cash.Flow.Operating, sub = "Validation Set", which.class = "1")
partialPlot(model4.RF, pred.data = new_data, x.var = Accounts.Payable, sub = "Validation Set", which.class = "1")
partialPlot(model4.RF, pred.data = new_data, x.var = Cost.of.Revenue, sub = "Validation Set", which.class = "1")

```

```{r}
model1.linear2 = lm( Accounts.Receivable ~ Accounts.Payable  + Add.l.income.expense.items + Net.Cash.Flow.Operating + Net.Cash.Flow.Operating:Net.Cash.Flows.Financing + 
                       Net.Cash.Flows.Financing + Cost.of.Revenue + Net.Income + Net.Income:Net.Income.Cont..Operations + Net.Income.Adjustments:Net.Income.Cont..Operations +
                       Net.Income.Adjustments + Net.Income:Net.Income.Adjustments +Operating.Income + Net.Cash.Flow.Operating:Net.Cash.Flows.Financing
                        + Net.Receivables   +  Net.Income : Operating.Income 
                         +Current.Ratio:Quick.Ratio + Operating.Margin:Profit.Margin - 1, data = new_var)
summary(model1.linear2)
```

```{r}
model2.step2 = step(model1.linear2)
summary(model2.step2)
```


```{r}
model1.mod2 = lm( Accounts.Receivable ~ Accounts.Payable + Cash.Ratio:Current.Ratio                   + Net.Borrowings + Add.l.income.expense.items + Net.Cash.Flow.Operating + Gross.Margin:Operating.Margin + Profit.Margin+ Net.Cash.Flows.Financing + Cost.of.Revenue + Net.Income + Net.Income:Net.Income.Cont..Operations +                     Net.Income.Adjustments + Operating.Income + Net.Cash.Flow.Operating:Net.Cash.Flows.Financing+ Net.Income:Net.Income.Adjustments +                     Net.Income.Cont..Operations + Net.Receivables  + Profit.Margin +  Net.Income:Operating.Income +                    Quick.Ratio:Cash.Ratio + Current.Ratio:Quick.Ratio + Gross.Margin + Operating.Margin:Profit.Margin, data = new_var)
```


```{r}
model1.mod2.step = step(model1.mod2)
summary(model1.mod2.step)
```

```{r}
model1.mod3 = lm(Accounts.Receivable ~ Accounts.Payable + Net.Borrowings + Add.l.income.expense.items + Net.Cash.Flow.Operating + Gross.Margin:Operating.Margin +       Net.Cash.Flows.Financing + Cost.of.Revenue + Net.Income + Net.Income:Net.Income.Cont..Operations + Net.Income.Adjustments + Operating.Income + Net.Cash.Flow.Operating:Net.Cash.Flows.Financing+ Net.Income:Net.Income.Adjustments +       Net.Income.Cont..Operations + Net.Receivables + Profit.Margin +  Net.Income:Operating.Income   Operating.Margin:Profit.Margin, data = new_var)
```

```{r}
#final model
model1.linear.final = lm( Accounts.Receivable ~ Accounts.Payable  + Add.l.income.expense.items + Net.Cash.Flow.Operating + Net.Cash.Flow.Operating:Net.Cash.Flows.Financing +                        Net.Cash.Flows.Financing + Cost.of.Revenue + Net.Income + Net.Income:Net.Income.Cont..Operations + Net.Income.Adjustments:Net.Income.Cont..Operations +                       Net.Income.Adjustments + Net.Income:Net.Income.Adjustments +Operating.Income + Net.Cash.Flow.Operating:Net.Cash.Flows.Financing                        + Net.Receivables   +  Net.Income : Operating.Income                          +Current.Ratio:Quick.Ratio + Operating.Margin:Profit.Margin - 1, data = new_var)
plot(model1.linear.final)
```

```{r}
 model.final = step(model1.linear.final)
summary(model.final)
```



```{r}
log.model1.linear.final = lm( log(Accounts.Receivable) ~ Accounts.Payable  + Add.l.income.expense.items + Net.Cash.Flow.Operating + Net.Cash.Flow.Operating:Net.Cash.Flows.Financing +                        Net.Cash.Flows.Financing + Cost.of.Revenue + Net.Income + Net.Income:Net.Income.Cont..Operations + Net.Income.Adjustments:Net.Income.Cont..Operations +                       Net.Income.Adjustments + Net.Income:Net.Income.Adjustments +Operating.Income + Net.Cash.Flow.Operating:Net.Cash.Flows.Financing                        + Net.Receivables   +  Net.Income : Operating.Income                          +Current.Ratio:Quick.Ratio + Operating.Margin:Profit.Margin - 1, data = new_var)
plot(log.model1.linear.final)
```

```{r}
#anova1
anova(model1.linear.final, model1.mod2)
```

```{r}
#anova2
anova(model1.linear.final, model2.step2)
```

```{r}
#anova3 
anova(model1.linear.final, model1.linear2)
```

```{r}
#anova4
anova(model1.linear.final,model1.mod2.step)
```

```{r}
#anova5
anova(model.final, model1.mod2)
```

